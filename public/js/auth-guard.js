// AUTH GUARD ULTRA SIMPLES - SISTEMA DEFINITIVO
let currentUser = null;
let menuMonitor = null;

// Fun√ß√£o para buscar dados do usu√°rio
function getUserData() {
    const userData = localStorage.getItem('user');
    const token = localStorage.getItem('token');
    
    if (!userData || !token) {
        return null;
    }
    
    try {
        const user = JSON.parse(userData);
        return { user, token };
    } catch (error) {
        console.error('‚ùå Erro ao parsear dados:', error);
        localStorage.clear();
        return null;
    }
}

// ATUALIZAR DADOS IMEDIATAMENTE
function loadUserDataImmediately() {
    console.log('üîç [AUTH-GUARD] loadUserDataImmediately chamada');
    const userData = getUserData();
    console.log('üîç [AUTH-GUARD] getUserData retornou:', userData);
    
    if (userData) {
        currentUser = userData.user;
        console.log('üî• DADOS DO USU√ÅRIO CARREGADOS IMEDIATAMENTE:', currentUser);
        console.log('üî• Nome:', currentUser?.name, 'Email:', currentUser?.email, 'Role:', currentUser?.role);
        updateUserInterface();
    } else {
        console.log('‚ùå [AUTH-GUARD] Nenhum userData encontrado');
    }
}

// Executar IMEDIATAMENTE
loadUserDataImmediately();

// FOR√áA MENU USU√ÅRIOS SEMPRE VIS√çVEL PARA ADMIN
function forceAdminMenu() {
    // DESABILITADO - Menu j√° est√° fixo no HTML das p√°ginas
    return;
    
    if (!currentUser || currentUser.role !== 'admin') return;
    
    // N√£o adicionar menu duplicado na pr√≥pria p√°gina de usu√°rios
    const currentPage = window.location.pathname.split('/').pop();
    if (currentPage === 'usuarios.html') return;
    
    // Encontrar TODOS os links de usu√°rios
    const selectors = [
        'a[href="usuarios.html"]',
        'a[href*="usuarios"]',
        '[data-page="usuarios"]'
    ];
    
    selectors.forEach(selector => {
        const links = document.querySelectorAll(selector);
        links.forEach(link => {
            const item = link.closest('li, .sidebar-item, .nav-item, .menu-item');
            if (item) {
                // FOR√áA VIS√çVEL
                item.style.display = 'flex !important';
                item.style.visibility = 'visible !important';
                item.style.opacity = '1 !important';
                item.classList.remove('hidden', 'd-none');
                item.classList.add('visible');
            }
        });
    });
}

// Atualizar interface do usu√°rio
function updateUserInterface() {

    
    if (!currentUser) {
        return;
    }
    
    console.log('üîÑ Atualizando interface para:', currentUser.name, currentUser.email);
    
    // Nome do usu√°rio - IMEDIATAMENTE
    const nameElements = document.querySelectorAll('#user-name, #userName, .user-name');
    nameElements.forEach(el => {
        if (el) {
            el.textContent = currentUser.name;
        }
    });
    
    // Email do usu√°rio - IMEDIATAMENTE  
    const emailElements = document.querySelectorAll('#userEmail, .user-email');
    emailElements.forEach(el => {
        if (el) {
            el.textContent = currentUser.email;
        }
    });
        }
    
    // √çcone do usu√°rio - IMEDIATAMENTE
    const iconElements = document.querySelectorAll('#user-icon, .user-icon');
    iconElements.forEach(icon => {
        if (icon) {
            icon.className = 'fas text-white';
            if (currentUser.role === 'admin') {
                icon.classList.add('fa-crown');
            } else {
                icon.classList.add('fa-user');
            }
        }
    });
    
    // FOR√áA MENU ADMIN
    setTimeout(forceAdminMenu, 300);

// Verificar acesso √† p√°gina
function checkPageAccess() {
    if (!currentUser) return false;
    
    const currentPage = window.location.pathname.split('/').pop();
    
    // P√°ginas que requerem privil√©gios de admin
    const adminOnlyPages = ['usuarios.html', 'fabric-admin.html'];
    
    if (adminOnlyPages.includes(currentPage)) {
        if (currentUser.role !== 'admin') {
            return false;
        }
    }
    
    // Demais p√°ginas s√£o acess√≠veis para usu√°rios logados
    return true;
}

// Logout
function logout() {
    try {
        // Adicionar delay extra para garantir que alerts.js esteja carregado
        setTimeout(() => {
            // Usar a fun√ß√£o de alerta bonita se estiver dispon√≠vel
            if (typeof confirmAction === 'function' || typeof window.confirmAction === 'function') {
                const confirmFunc = confirmAction || window.confirmAction;
                confirmFunc('Deseja realmente sair do sistema? Voc√™ precisar√° fazer login novamente para acessar o sistema.', 'Confirmar Logout')
                    .then((confirmed) => {
                        if (confirmed) {
                            // Confirmou o logout
                            if (menuMonitor) clearInterval(menuMonitor);
                            localStorage.clear();
                            sessionStorage.clear();
                            currentUser = null;
                            if (typeof showSuccess === 'function' || typeof window.showSuccess === 'function') {
                                const successFunc = showSuccess || window.showSuccess;
                                successFunc('Logout realizado com sucesso! Redirecionando...');
                                setTimeout(() => window.location.replace('login.html'), 1500);
                            } else {
                                window.location.replace('login.html');
                            }
                        } else {
                            // Cancelou o logout
                            if (typeof showInfo === 'function' || typeof window.showInfo === 'function') {
                                const infoFunc = showInfo || window.showInfo;
                                infoFunc('Logout cancelado.');
                            }
                        }
                    })
                    .catch((error) => {
                        console.error('‚ùå Erro no modal de confirma√ß√£o:', error);
                        // Fallback simples
                        if (confirm('Deseja realmente sair do sistema?')) {
                            if (menuMonitor) clearInterval(menuMonitor);
                            localStorage.clear();
                            sessionStorage.clear();
                            currentUser = null;
                            window.location.replace('login.html');
                        }
                    });
            } else {
                // Fallback para quando n√£o h√° fun√ß√£o de alerta
                if (confirm('Deseja realmente sair do sistema?')) {
                    if (menuMonitor) clearInterval(menuMonitor);
                    localStorage.clear();
                    sessionStorage.clear();
                    currentUser = null;
                    window.location.replace('login.html');
                }
            }
        }, 100); // Delay de 100ms para garantir que tudo esteja carregado
    } catch (error) {
        console.error('‚ùå Erro no logout:', error);
        // Fallback simples
        if (menuMonitor) clearInterval(menuMonitor);
        localStorage.clear();
        sessionStorage.clear();
        currentUser = null;
        window.location.replace('login.html');
    }
}

// INICIALIZA√á√ÉO PRINCIPAL
function initializeAuth() {
    
    const currentPage = window.location.pathname.split('/').pop();
    
    // Se for login, n√£o verificar
    if (currentPage === 'login.html' || currentPage === '' || currentPage === 'index.html') {
        return;
    }
    
    const authData = getUserData();
    
    if (!authData) {
        window.location.replace('login.html');
        return;
    }
    
    currentUser = authData.user;
    
    if (!checkPageAccess()) {
        // Usar alerta bonito se dispon√≠vel
        setTimeout(() => {
            if (typeof showError === 'function' || typeof window.showError === 'function') {
                const errorFunc = showError || window.showError;
                errorFunc('Acesso Negado! Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.');
            } else {
                alert('Acesso negado! Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.');
            }
            
            // Redirecionar ap√≥s o alerta
            setTimeout(() => {
                if (currentUser.role === 'admin') {
                    window.location.replace('usuarios.html');
                } else {
                    window.location.replace('inputs.html');
                }
            }, 2000);
        }, 100);
        return;
    }
    
    updateUserInterface();
    
    // MONITOR CONT√çNUO DO MENU ADMIN
    if (currentUser.role === 'admin') {
        menuMonitor = setInterval(() => {
            forceAdminMenu();
        }, 1000); // A cada 1 segundo
    }
    
    // Configurar logout
    setTimeout(() => {
        const logoutElements = document.querySelectorAll('a[href="login.html"], [data-action="logout"], .logout-btn, [onclick*="logout()"], button[title="Sair"]');
        logoutElements.forEach(el => {
            // Remover onclick inline se existir
            if (el.hasAttribute('onclick')) {
                el.removeAttribute('onclick');
            }
            
            // Remover listeners anteriores para evitar duplica√ß√£o
            el.removeEventListener('click', handleLogoutClick);
            
            el.addEventListener('click', handleLogoutClick);
        });
    }, 500);
}

// Fun√ß√£o separada para o click do logout
function handleLogoutClick(e) {
    e.preventDefault();
    e.stopPropagation();
    logout();
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    initializeAuth();
    updateUserInterface(); // For√ßa atualiza√ß√£o
});

window.addEventListener('load', function() {
    if (currentUser) updateUserInterface();
});

// Garantir atualiza√ß√£o em navega√ß√£o
window.addEventListener('focus', function() {
    if (currentUser) {
        updateUserInterface();
        if (currentUser.role === 'admin') {
            forceAdminMenu();
        }
    }
});

// Exportar para uso global
window.authGuard = {
    getCurrentUser: () => currentUser,
    logout: logout,
    forceMenu: forceAdminMenu
};

window.logout = logout;
