<!DOCTYPE html>
<html>
<head>
    <title>Teste API ModelAI</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Teste da API ModelAI</h1>
    
    <button onclick="testCreateUser()">üßë‚Äçüíª Criar Usu√°rio de Teste</button>
    <button onclick="testLogin()">üîê Testar Login</button>
    <button onclick="testListUsers()">üìã Listar Usu√°rios</button>
    <button onclick="clearResults()">üßπ Limpar Resultados</button>
    
    <div id="results"></div>

    <script>
        const API_BASE = window.location.origin + '/api';
        let token = null;

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            document.getElementById('results').appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testCreateUser() {
            try {
                log('üßë‚Äçüíª Criando usu√°rio de teste...', 'info');
                
                // Primeiro fazer login como admin
                const loginData = {
                    email: 'administrador@modelai.com',
                    password: 'admin123'
                };

                const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData)
                });

                if (!loginResponse.ok) {
                    throw new Error(`Login falhou: ${await loginResponse.text()}`);
                }

                const loginResult = await loginResponse.json();
                token = loginResult.token;
                log('‚úÖ Login admin bem-sucedido', 'success');

                // Agora criar usu√°rio
                const userData = {
                    name: 'Usu√°rio Teste',
                    email: 'teste@modelai.com',
                    password: '123456',
                    company: 'Empresa Teste',
                    role: 'user'
                };

                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Usu√°rio criado com sucesso!', 'success');
                    log(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'success');
                } else {
                    log(`‚ùå Erro ao criar usu√°rio: ${result.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            try {
                log('üîê Testando login do usu√°rio criado...', 'info');
                
                const loginData = {
                    email: 'teste@modelai.com',
                    password: '123456'
                };

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Login do usu√°rio teste bem-sucedido!', 'success');
                    log(`<pre>${JSON.stringify(result.user, null, 2)}</pre>`, 'success');
                    token = result.token;
                } else {
                    log(`‚ùå Erro no login: ${result.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function testListUsers() {
            try {
                log('üìã Listando usu√°rios...', 'info');
                
                if (!token) {
                    // Fazer login como admin primeiro
                    const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'administrador@modelai.com',
                            password: 'admin123'
                        })
                    });
                    
                    if (loginResponse.ok) {
                        const loginResult = await loginResponse.json();
                        token = loginResult.token;
                    }
                }

                const response = await fetch(`${API_BASE}/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ ${result.users.length} usu√°rios encontrados`, 'success');
                    result.users.forEach(user => {
                        log(`üë§ ${user.name} (${user.email}) - Role: ${user.role} - Ativo: ${user.isActive}`, 'info');
                    });
                } else {
                    log(`‚ùå Erro ao listar usu√°rios: ${result.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
